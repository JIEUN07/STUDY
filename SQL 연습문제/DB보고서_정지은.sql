/* 7장 UK COMMERCE 데이터 이용한 리포트 작성  */
-- 1. 국가별, 상품별 구매지표 추출
-- 2. 특정 상품 구매자가 구매한 다른상품
-- 3. 국가별 재구매율 계산
-- 4. 코호트 분석
-- 5. 고객 SEGMENT            

SELECT * FROM DATASET3;
-- 1. 국가별, 상품별 구매자 수 및 매출액

SELECT COUNTRY, STOCKCODE,
COUNT(DISTINCT CUSTOMERID) BUY,
SUM(QUANTITY*UNITPRICE) SALES
FROM DATASET3
GROUP BY 1,2
ORDER BY 3 DESC, 4 DESC;

-- 2. 특정 상품 구매자가 구매한 다른상품
-- 1) 가장 많이 판매된 2개 상품조회 (판매 상품수 기준)
SELECT STOCKCODE, SUM(QUANTITY) QTY, 
RANK() OVER(ORDER BY SUM(QUANTITY) DESC) RNK
FROM DATASET3
GROUP BY 1
ORDER BY 2 DESC;

SELECT *
FROM(SELECT STOCKCODE, SUM(QUANTITY) QTY, 
RANK() OVER(ORDER BY SUM(QUANTITY) DESC) RNK
FROM DATASET3
GROUP BY 1
ORDER BY 2 DESC) A
WHERE RNK BETWEEN 1 AND 2;

SELECT STOCKCODE FROM (SELECT *
FROM(SELECT STOCKCODE, SUM(QUANTITY) QTY, 
RANK() OVER(ORDER BY SUM(QUANTITY) DESC) RNK
FROM DATASET3
GROUP BY 1
ORDER BY 2 DESC) A
WHERE RNK BETWEEN 1 AND 2) B; -- 84077, 85123A

SELECT CUSTOMERID, STOCKCODE, 
CASE WHEN STOCKCODE = '84077' THEN 1 ELSE 0 END A,
CASE WHEN STOCKCODE = '85123A' THEN 1 ELSE 0 END B
FROM DATASET3;

-- 2) 가장 많이 판매된 2개의 상품 모두 구매한 구매자가 구매한 상품
SELECT * FROM DATASET3
WHERE STOCKCODE = '84077';

DESC DATASET3;
INSERT INTO DATASET3 VALUES(536372,	'84077','WORLD WAR 2 GLIDERS ASSTD DESIGNS',6,	1.85, 17850, 'United Kingdom',	'2010-01-12');
INSERT INTO DATASET3 VALUES(536372,	'85123A','WORLD WAR 2 GLIDERS ASSTD DESIGNS',6,	1.85, 17850, 'United Kingdom',	'2010-01-12');
INSERT INTO DATASET3 VALUES(536372,	'84077','WORLD WAR 2 GLIDERS ASSTD DESIGNS',6,	1.85, 13047, 'United Kingdom',	'2010-01-12');
INSERT INTO DATASET3 VALUES(536372,	'85123A','WORLD WAR 2 GLIDERS ASSTD DESIGNS',6,	1.85, 13047, 'United Kingdom',	'2010-01-12');
INSERT INTO DATASET3 VALUES(536372,	'84077','WORLD WAR 2 GLIDERS ASSTD DESIGNS',6,	1.85, 12583, 'United Kingdom',	'2010-01-12');
INSERT INTO DATASET3 VALUES(536372,	'85123A','WORLD WAR 2 GLIDERS ASSTD DESIGNS',6,	1.85, 12583, 'United Kingdom',	'2010-01-12');

SELECT *, A+B
FROM (SELECT CUSTOMERID, STOCKCODE, 
CASE WHEN STOCKCODE = '84077' THEN 1 ELSE 0 END A,
CASE WHEN STOCKCODE = '85123A' THEN 1 ELSE 0 END B
FROM DATASET3) TEM
WHERE A+B = 2;  -- 두상품 모두 구매한 구매자

SELECT STORCKCODE
FROM DATASET3
WHERE CUSTOMERID = '' AND STOCKCODE NOT IN ('84077', '85123A');

-- 3. 국가별 재구매율 계산
INSERT INTO DATASET3 VALUES(

SELECT CUSTOMERID, COUNTRY, SUBSTR(INVOICEDATE, 1,4) YY 
FROM DATASET3
GROUP BY 2;
HAVING YY = 2010 AND YY = 2011;
ORDER BY CUSTOMERID;

SELECT CUSTOMERID, COUNTRY 
FROM (SELECT CUSTOMERID, COUNTRY, SUBSTR(INVOICEDATE, 1,4) YY 
FROM DATASET3)
GROUP BY 2
HAVING YY = 2010 AND YY = 2011;




